services:
  # Mock GPU cluster (simulates multiple GPU servers)
  mock-cluster:
    build:
      context: ..
      dockerfile: tests/Dockerfile.test
    container_name: gpu-hot-mock-cluster
    hostname: mock-cluster
    ports:
      - "13120-13150:13120-13150"
    environment:
      # LOAD TEST PRESETS - uncomment one:
      # LIGHT: 3 nodes, 14 GPUs (typical small lab)
      - NODES=2,4,8
      # MEDIUM: 8 nodes, 64 GPUs (medium cluster)
      #- NODES=8,8,8,8,8,8,8,8
      # HEAVY: 20 nodes, 160 GPUs (large production)
      # - NODES=8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8
      
      - BASE_PORT=13120
      - PREFIX=gpu-server
    networks:
      gpu-hot-test:
        aliases:
          - mock-cluster

  # Hub (aggregates all mock nodes)
  hub:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: gpu-hot-hub
    ports:
      - "1312:1312"
    environment:
      - GPU_HOT_MODE=hub
      # Must match NODES count above:
      # LIGHT (3):
      - NODE_URLS=http://mock-cluster:13120,http://mock-cluster:13121,http://mock-cluster:13122
      # MEDIUM (8):
      #- NODE_URLS=http://mock-cluster:13120,http://mock-cluster:13121,http://mock-cluster:13122,http://mock-cluster:13123,http://mock-cluster:13124,http://mock-cluster:13125,http://mock-cluster:13126,http://mock-cluster:13127
      # HEAVY (20):
      # - NODE_URLS=http://mock-cluster:13120,http://mock-cluster:13121,http://mock-cluster:13122,http://mock-cluster:13123,http://mock-cluster:13124,http://mock-cluster:13125,http://mock-cluster:13126,http://mock-cluster:13127,http://mock-cluster:13128,http://mock-cluster:13129,http://mock-cluster:13130,http://mock-cluster:13131,http://mock-cluster:13132,http://mock-cluster:13133,http://mock-cluster:13134,http://mock-cluster:13135,http://mock-cluster:13136,http://mock-cluster:13137,http://mock-cluster:13138,http://mock-cluster:13139
    depends_on:
      mock-cluster:
        condition: service_started
    networks:
      - gpu-hot-test

networks:
  gpu-hot-test:
    driver: bridge

